<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cart</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        .cart-thumb {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            margin-right: 15px;
            background: #eee;
        }
    </style>
</head>
<body>
<nav>
    <h1>üõí Your Cart</h1>
    <a href="/dashboard">‚Üê Back to Shopping</a>
</nav>

<div class="container">
    <div id="cart-items" class="cart-list">
        <p>Loading...</p>
    </div>

    <div style="margin-top: 20px; text-align: right;">
        <h3>Total: <span id="total-price">0</span> ‚Ç∏</h3>
        <button onclick="checkout()" class="btn">‚úÖ Checkout</button>
        <button onclick="clearCart()" class="btn" style="background: #e74c3c;">üóë Clear Cart</button>
    </div>
</div>

<script>
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const container = document.getElementById('cart-items');
    const totalSpan = document.getElementById('total-price');

    function renderCart() {
        container.innerHTML = '';
        let total = 0;
        if (cart.length === 0) {
            container.innerHTML = '<p>Your cart is empty. <a href="/dashboard">Go shopping!</a></p>';
            totalSpan.innerText = 0;
            return;
        }

        cart.forEach((item, index) => {
            total += item.price;

            const imgSrc = (item.imageUrl && item.imageUrl.startsWith('http'))
                ? item.imageUrl
                : 'https://placehold.co/100?text=üì¶';

            container.innerHTML += `
                    <div style="background:white; padding:15px; margin-bottom:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center;">
                            <img src="${imgSrc}" class="cart-thumb">
                            <div>
                                <strong>${item.title}</strong>
                                <br>
                                <small>${item.price} ‚Ç∏</small>
                            </div>
                        </div>
                        <button onclick="removeItem(${index})" style="background:#e74c3c; padding:5px 10px; font-size:0.8rem;">Remove</button>
                    </div>
                `;
        });
        totalSpan.innerText = total;
    }

    function removeItem(index) {
        cart.splice(index, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
    }

    function clearCart() {
        localStorage.removeItem('cart');
        window.location.reload();
    }

    async function checkout() {
        if(cart.length === 0) return alert('Cart is empty!');
        const token = localStorage.getItem('token');

        const orderData = {
            products: cart.map(item => ({
                product: item.id,
                title: item.title,
                price: item.price,
                quantity: 1
            })),
            totalPrice: parseInt(totalSpan.innerText)
        };

        const res = await fetch('/api/orders', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(orderData)
        });

        if (res.ok) {
            alert('Order placed successfully!');
            localStorage.removeItem('cart');
            window.location.href = '/dashboard';
        } else {
            alert('Error placing order');
        }
    }

    renderCart();
</script>
</body>
</html>