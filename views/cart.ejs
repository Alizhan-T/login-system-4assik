<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ö–æ—Ä–∑–∏–Ω–∞</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
<nav>
    <h1>üõí –í–∞—à–∞ –ö–æ—Ä–∑–∏–Ω–∞</h1>
    <a href="/dashboard">‚Üê –ù–∞–∑–∞–¥ –∫ –ø–æ–∫—É–ø–∫–∞–º</a>
</nav>

<div class="container">
    <div id="cart-items" class="cart-list">
        <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>

    <div style="margin-top: 20px; text-align: right;">
        <h3>–ò—Ç–æ–≥–æ: <span id="total-price">0</span> ‚Ç∏</h3>
        <button onclick="checkout()" class="btn">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        <button onclick="clearCart()" class="btn" style="background: #e74c3c;">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
</div>

<script>
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const container = document.getElementById('cart-items');
    const totalSpan = document.getElementById('total-price');

    function renderCart() {
        container.innerHTML = '';
        let total = 0;

        if (cart.length === 0) {
            container.innerHTML = '<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞. <a href="/dashboard">–ò–¥–∏—Ç–µ –ø–æ–∫—É–ø–∞—Ç—å!</a></p>';
            return;
        }

        cart.forEach((item, index) => {
            total += item.price;
            container.innerHTML += `
                    <div style="background:white; padding:15px; margin-bottom:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong>${item.title}</strong>
                            <br>
                            <small>${item.price} ‚Ç∏</small>
                        </div>
                        <button onclick="removeItem(${index})" style="background:#e74c3c; padding:5px 10px; font-size:0.8rem;">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;
        });
        totalSpan.innerText = total;
    }

    function removeItem(index) {
        cart.splice(index, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
    }

    function clearCart() {
        localStorage.removeItem('cart');
        window.location.reload();
    }

    async function checkout() {
        if(cart.length === 0) return alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!');

        const token = localStorage.getItem('token');

        const orderData = {
            products: cart.map(item => ({
                product: item.id, // ID —Ç–æ–≤–∞—Ä–∞
                title: item.title,
                price: item.price,
                quantity: 1
            })),
            totalPrice: parseInt(totalSpan.innerText)
        };

        const res = await fetch('/api/orders', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(orderData)
        });

        if (res.ok) {
            alert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!');
            localStorage.removeItem('cart');
            // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (Dashboard)
            window.location.href = '/dashboard';
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫–∞–∑–µ');
        }
    }

    renderCart();
</script>
</body>
</html>