<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALIZHMARKET | –ì–ª–∞–≤–Ω–∞—è</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ */
        .status-new { color: #f39c12; font-weight: bold; }
        .status-completed { color: #27ae60; font-weight: bold; }
        .status-canceled { color: #c0392b; font-weight: bold; text-decoration: line-through; }

        .order-card {
            background: white;
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>

<nav>
    <div style="display: flex; align-items: center; gap: 15px;">
        <h1>üöÄ ALIZHMARKET</h1>
    </div>

    <div style="display: flex; align-items: center; gap: 20px;">
        <span style="color: #555;">
            <%= user.name %>
            <span class="role-badge" style="background: <%= user.role === 'farmer' ? '#e67e22' : '#2ecc71' %>; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">
                <%= user.role === 'farmer' ? '–§–µ—Ä–º–µ—Ä' : '–ü–æ–∫—É–ø–∞—Ç–µ–ª—å' %>
            </span>
        </span>

        <% if (user.role === 'buyer') { %>
            <a href="/cart">üõí –ö–æ—Ä–∑–∏–Ω–∞ (<span id="cart-count">0</span>)</a>
        <% } %>
        <button onclick="logout()" class="btn btn-logout" style="padding: 5px 15px;">–í—ã–π—Ç–∏</button>
    </div>
</nav>

<div class="container">

    <div style="margin-bottom: 40px;">
        <h2>üì¶ <%= user.role === 'buyer' ? '–ú–æ–∏ –∑–∞–∫–∞–∑—ã' : '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏' %></h2>

        <% if (orders && orders.length > 0) { %>
            <% orders.forEach(order => { %>
                <div class="order-card">
                    <div>
                        <strong>–ó–∞–∫–∞–∑ #<%= order._id.toString().slice(-4) %></strong>
                        <span style="margin-left: 10px;">
                            <% if(order.status === 'new') { %> <span class="status-new">üïí –í –æ–±—Ä–∞–±–æ—Ç–∫–µ</span> <% } %>
                            <% if(order.status === 'completed') { %> <span class="status-completed">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ</span> <% } %>
                            <% if(order.status === 'canceled') { %> <span class="status-canceled">‚ùå –û—Ç–º–µ–Ω–µ–Ω</span> <% } %>
                        </span>
                        <div style="font-size: 0.9rem; color: #777;">
                            –°—É–º–º–∞: <%= order.totalPrice %> ‚Ç∏ | –¢–æ–≤–∞—Ä–æ–≤: <%= order.products.length %>
                        </div>
                    </div>

                    <div>
                        <% if (user.role === 'buyer' && order.status === 'new') { %>
                            <button onclick="cancelOrder('<%= order._id %>')" style="background: #e74c3c; padding: 5px 10px; font-size: 0.8rem;">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                        <% } %>

                        <% if (user.role === 'farmer' && order.status === 'new') { %>
                            <button onclick="completeOrder('<%= order._id %>')" style="background: #27ae60; padding: 5px 10px; font-size: 0.8rem;">–í—ã–ø–æ–ª–Ω–∏—Ç—å ‚úÖ</button>
                        <% } %>
                    </div>
                </div>
            <% }) %>
        <% } else { %>
            <p style="color: #777;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤.</p>
        <% } %>
    </div>

    <hr style="margin: 30px 0; border: 0; border-top: 1px solid #ddd;">

    <% if (user.role === 'farmer') { %>
        <div class="auth-box">
            <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h3>
            <form id="addProductForm">
                <input type="text" id="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required style="margin-bottom:10px;">
                <input type="number" id="price" placeholder="–¶–µ–Ω–∞" required style="margin-bottom:10px;">
                <input type="text" id="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" required style="margin-bottom:10px;">
                <select id="category" style="margin-bottom:10px;">
                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                    <option value="vegetables">–û–≤–æ—â–∏</option>
                </select>
                <button type="submit">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </form>
        </div>
    <% } %>

    <h2 style="margin-top: 30px;">üçè –í–∏—Ç—Ä–∏–Ω–∞ —Ç–æ–≤–∞—Ä–æ–≤</h2>
    <div class="market-grid">
        <% products.forEach(product => { %>
            <div class="product-card">
                <div class="product-info">
                    <h3><%= product.title %></h3>
                    <p><%= product.price %> ‚Ç∏</p>
                    <% if (user.role === 'buyer') { %>
                        <button onclick="addToCart('<%= product._id %>', '<%= product.title %>', <%= product.price %>)" class="btn">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                    <% } %>
                </div>
            </div>
        <% }) %>
    </div>

</div>

<script>
    // --- –õ–æ–≥–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ ---

    async function cancelOrder(id) {
        if(!confirm('–¢–æ—á–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑?')) return;
        const res = await fetch(`/api/orders/${id}/cancel`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if(res.ok) window.location.reload();
        else alert('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã');
    }

    async function completeOrder(id) {
        const res = await fetch(`/api/orders/${id}/complete`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if(res.ok) window.location.reload();
        else alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
    }

    // --- –õ–æ–≥–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã –∏ –≤—ã—Ö–æ–¥–∞ (—Å—Ç–∞—Ä–∞—è) ---
    function addToCart(id, title, price) {
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        cart.push({ id, title, price });
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartCount();
    }

    function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        const badge = document.getElementById('cart-count');
        if(badge) badge.innerText = cart.length;
    }
    updateCartCount();

    function logout() {
        document.cookie = "token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        localStorage.removeItem('token');
        window.location.href = '/login';
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
    const addProductForm = document.getElementById('addProductForm');
    if (addProductForm) {
        addProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            // –°–æ–±–µ—Ä–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ fetch POST /api/products
            // (–ö–æ–¥ –∞–Ω–∞–ª–æ–≥–∏—á–µ–Ω —Ç–æ–º—É, —á—Ç–æ —è –¥–∞–≤–∞–ª –≤ –ø—Ä–æ—à–ª–æ–º –æ—Ç–≤–µ—Ç–µ)
            window.location.reload();
        });
    }
</script>
</body>
</html>