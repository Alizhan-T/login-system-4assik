<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALIZHMARKET | Dashboard</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        .product-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-bottom: 1px solid #eee;
        }
        .no-img {
            height: 200px;
            background: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #bdc3c7;
        }
    </style>
</head>
<body>

<nav>
    <div style="display: flex; align-items: center; gap: 15px;">
        <h1>üöÄ ALIZHMARKET</h1>
    </div>

    <div style="display: flex; align-items: center; gap: 20px;">
        <span style="color: var(--dark);">
            <%= user.name %>
            <span class="role-badge" style="background: <%= user.role === 'farmer' ? '#e67e22' : '#2ecc71' %>; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">
                 <%= user.role === 'farmer' ? 'Farmer' : 'Buyer' %>
            </span>
        </span>

        <% if (user.role === 'buyer') { %>
            <a href="/cart">üõí Cart (<span id="cart-count">0</span>)</a>
        <% } %>
        <button onclick="logout()" class="btn btn-logout" style="padding: 5px 15px;">Logout</button>
    </div>
</nav>

<div class="container">

    <div style="margin-bottom: 40px;">
        <h2>üì¶ <%= user.role === 'buyer' ? 'My Orders' : 'Order Management' %></h2>

        <% if (orders && orders.length > 0) { %>
            <% orders.forEach(order => { %>
                <div class="order-card">
                    <div>
                        <strong>Order #<%= order._id.toString().slice(-4) %></strong>
                        <span style="margin-left: 10px;">
                            <% if(order.status === 'new') { %> <span class="status-new">üïí Pending</span> <% } %>
                            <% if(order.status === 'completed') { %> <span class="status-completed">‚úÖ Completed</span> <% } %>
                            <% if(order.status === 'canceled') { %> <span class="status-canceled">‚ùå Canceled</span> <% } %>
                        </span>
                        <div style="font-size: 0.9rem; color: #777;">
                            Total: <%= order.totalPrice %> ‚Ç∏ | Items: <%= order.products.length %>
                        </div>
                    </div>

                    <div>
                        <% if (user.role === 'buyer' && order.status === 'new') { %>
                            <button onclick="cancelOrder('<%= order._id %>')" style="background: #e74c3c; padding: 5px 10px; font-size: 0.8rem;">Cancel</button>
                        <% } %>

                        <% if (user.role === 'farmer' && order.status === 'new') { %>
                            <button onclick="completeOrder('<%= order._id %>')" style="background: #27ae60; padding: 5px 10px; font-size: 0.8rem;">Complete ‚úÖ</button>
                        <% } %>
                    </div>
                </div>
            <% }) %>
        <% } else { %>
            <p style="color: #777;">You have no active orders yet.</p>
        <% } %>
    </div>

    <hr style="margin: 30px 0; border: 0; border-top: 1px solid #ddd;">

    <% if (user.role === 'farmer') { %>
        <div class="auth-box">
            <h3>‚ûï Add Product</h3>
            <form id="addProductForm">
                <input type="text" id="title" placeholder="Product Title" required style="margin-bottom:10px;">
                <input type="number" id="price" placeholder="Price (‚Ç∏)" required style="margin-bottom:10px;">
                <input type="url" id="imageUrl" placeholder="Image URL (http://...)" style="margin-bottom:10px;">
                <input type="text" id="description" placeholder="Description" required style="margin-bottom:10px;">

                <select id="category" style="margin-bottom:10px;">
                    <option value="other">Other</option>
                    <option value="vegetables">Vegetables ü•¶</option>
                    <option value="fruits">Fruits üçé</option>
                    <option value="dairy">Dairy ü•õ</option>
                    <option value="meat">Meat ü•©</option>
                </select>

                <button type="submit">Publish</button>
            </form>
        </div>
    <% } %>

    <h2 style="margin-top: 30px;">üçè Marketplace</h2>
    <div class="market-grid">
        <% products.forEach(product => { %>
            <div class="product-card">

                <% if (product.imageUrl && product.imageUrl.startsWith('http')) { %>
                    <img src="<%= product.imageUrl %>" alt="<%= product.title %>" class="product-img" onerror="this.style.display='none'">
                <% } else { %>
                    <div class="no-img">
                        <%
                            let icon = 'üì¶';
                            if (product.category === 'vegetables') icon = 'ü•¶';
                            else if (product.category === 'fruits') icon = 'üçé';
                            else if (product.category === 'meat') icon = 'ü•©';
                            else if (product.category === 'dairy') icon = 'ü•õ';
                        %>
                        <%= icon %>
                    </div>
                <% } %>

                <div class="product-info">
                    <h3><%= product.title %></h3>
                    <p style="color:#777; font-size:0.9rem; font-weight:400; margin-bottom:5px;"><%= product.description %></p>
                    <p style="color:var(--primary); font-weight:700; font-size:1.2rem;"><%= product.price %> ‚Ç∏</p>

                    <% if (user.role === 'buyer') { %>
                        <button onclick="addToCart('<%= product._id %>', '<%= product.title %>', <%= product.price %>, '<%= product.imageUrl %>')" class="btn">Add to Cart</button>
                    <% } %>
                </div>
            </div>
        <% }) %>
    </div>

</div>

<script>
    async function cancelOrder(id) {
        if(!confirm('Are you sure?')) return;
        const res = await fetch(`/api/orders/${id}/cancel`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if(res.ok) window.location.reload();
        else alert('Error canceling order');
    }

    async function completeOrder(id) {
        const res = await fetch(`/api/orders/${id}/complete`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if(res.ok) window.location.reload();
        else alert('Error updating status');
    }

    function addToCart(id, title, price, imageUrl) {
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        cart.push({ id, title, price, imageUrl });
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartCount();
        alert('Added to cart!');
    }

    function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        const badge = document.getElementById('cart-count');
        if(badge) badge.innerText = cart.length;
    }
    updateCartCount();

    function logout() {
        localStorage.removeItem('token');
        document.cookie = "token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        window.location.href = '/logout';
    }

    const addProductForm = document.getElementById('addProductForm');
    if (addProductForm) {
        addProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const title = document.getElementById('title').value;
            const price = document.getElementById('price').value;
            const description = document.getElementById('description').value;
            const category = document.getElementById('category').value;
            const imageUrl = document.getElementById('imageUrl').value;
            const token = localStorage.getItem('token');

            try {
                const res = await fetch('/api/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ title, price, description, category, imageUrl })
                });

                if (res.ok) {
                    alert('Product added successfully!');
                    window.location.reload();
                } else {
                    const data = await res.json();
                    alert(data.message || 'Error adding product');
                }
            } catch (err) {
                console.error(err);
                alert('Network error');
            }
        });
    }
</script>
</body>
</html>